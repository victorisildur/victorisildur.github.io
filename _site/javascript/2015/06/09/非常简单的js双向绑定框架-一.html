<!DOCTYPE html>
<html>
  	<head>
  		<title>VictorIsildur's Blog</title>
  		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
  		<meta name="description" content="" />
  		<meta name="keywords" content="" />
  		<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
  		<script src="/js/jquery.min.js"></script>
  		<script src="/js/jquery.poptrox.min.js"></script>
  		<script src="/js/skel.min.js"></script>
  		<script src="/js/init.js"></script>
  		<noscript>
  			<link rel="stylesheet" href="/css/skel.css" />
  			<link rel="stylesheet" href="/css/style.css" />
  			<link rel="stylesheet" href="/css/style-xlarge.css" />
  		</noscript>
  		<!--[if lte IE 8]><link rel="stylesheet" href="/css/ie/v8.css" /><![endif]-->
  	</head>

	<body id="top">

      <header id="header">
          <a href="#" class="image avatar"><img src="/images/aragon.jpg" alt="" /></a>
          <h1><strong>I am <a href="https://github.com/victorisildur">VictorIsildur</a></strong>. First a programmer<br />
          Then a web coder<br />
      </header>


        <div id="main">
    <article>
        <header class="major">
            <h2 class="post-title">2015-06-09-非常简单的js双向绑定框架（一）</h2>
                <p class="post-meta">Jun 9, 2015</p>
        </header>

        <section>
            <h1 id="section">初衷</h1>
<p>搞了近5个月的angularjs项目，用起来非常顺手。最爽的是两个功能：</p>
<ol>
  <li>控制器的继承特性</li>
  <li>数据的双向绑定</li>
  <li>表达式控制显示与否
前者减少了很多model的重复声明，赋值。后者大大简化了动态编辑，动态显示。比如我的表格需要根据某一列排序，我只用改动数据模型的顺序，视图会自动更新。
但是，作为“Get your hands dirty”的小项目，用脏值检测和dom树编译太难了，目标1周的话搞不掂。所以借鉴knockoutjs的方法：</li>
</ol>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">myViewModel</span> <span class="o">=</span> <span class="p">{</span>
    <span class="na">personName</span><span class="p">:</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observable</span><span class="p">(</span><span class="s1">'Bob'</span><span class="p">),</span>
    <span class="na">personAge</span><span class="p">:</span> <span class="nx">ko</span><span class="p">.</span><span class="nx">observable</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
<span class="p">};</span>
<span class="nx">ko</span><span class="p">.</span><span class="nx">applyBindings</span><span class="p">(</span><span class="nx">myViewModel</span><span class="p">,</span> <span class="nb">document</span><span class="p">.</span><span class="nx">getElementById</span><span class="p">(</span><span class="s1">'my-view'</span><span class="p">));</span>
</code></pre>
</div>

<p>手动的把一个js object绑到某个DOM元素上去。</p>
<h1 id="section-1">目标</h1>
<ol>
  <li>实现数据的双向绑定(input, textarea, select)</li>
  <li>实现控制器继承，控制器的作用范围在html里声明，而不是像knockout一样用js声明</li>
  <li>基本事件的绑定，如click</li>
  <li>类似ng-show这样的表达式控制显隐</li>
</ol>

<h1 id="section-2">第一个特性：双向绑定</h1>
<p>参考这篇blog: <a href="http://www.lucaongaro.eu/blog/2012/12/02/easy-two-way-data-binding-in-javascript/">pubsub双向绑定</a>
我们用原生js先实现pubsub本身，为了代码的独立性，不像原文一样做dom操作：</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;body</span> <span class="na">isi-controller=</span><span class="s">"MainController"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;script </span><span class="na">type=</span><span class="s">"text/javascript"</span><span class="nt">&gt;</span>
      <span class="kd">var</span> <span class="nx">myModel</span><span class="p">;</span>
      <span class="nb">window</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	      <span class="nx">myModel</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Model</span><span class="p">;</span>
	      <span class="nx">myModel</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="s2">"name"</span><span class="p">,</span> <span class="s2">"isildur"</span> <span class="p">);</span>
      <span class="p">}</span>
    <span class="nt">&lt;/script&gt;</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">"text"</span> <span class="na">data-bind=</span><span class="s">"name"</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/body&gt;</span>   
</code></pre>
</div>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">pubsub</span> <span class="o">=</span> <span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">_callbacks</span> <span class="o">=</span> <span class="p">{};</span>
    <span class="kd">var</span> <span class="nx">pubsub</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">sub</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">,</span> <span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="nx">_callbacks</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">_callbacks</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[];</span>
            <span class="p">}</span>
            <span class="nx">_callbacks</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">push</span><span class="p">(</span><span class="nx">callback</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="na">pub</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="nb">Array</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">slice</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span> <span class="nx">_callbacks</span><span class="p">.</span><span class="nx">hasOwnProperty</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
                <span class="nx">_callbacks</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">forEach</span><span class="p">(</span> <span class="kd">function</span><span class="p">(</span><span class="nx">callback</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nx">callback</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">);</span>
                <span class="p">});</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">pubsub</span><span class="p">;</span>
<span class="p">})();</span>

<span class="c1">// listener capture view change event --&gt; publish view.change event</span>
<span class="kd">var</span> <span class="nx">changeHandler</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">target</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">target</span><span class="p">,</span>
        <span class="nx">propName</span> <span class="o">=</span> <span class="nx">target</span><span class="p">.</span><span class="nx">getAttribute</span><span class="p">(</span><span class="s1">'data-bind'</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span> <span class="nx">propName</span> <span class="o">&amp;&amp;</span> <span class="nx">propName</span> <span class="o">!==</span> <span class="s1">''</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">pubsub</span><span class="p">.</span><span class="nx">pub</span><span class="p">(</span><span class="s1">'model.change'</span><span class="p">,</span> <span class="nx">propName</span><span class="p">,</span> <span class="nx">target</span><span class="p">.</span><span class="nx">value</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'change'</span><span class="p">,</span> <span class="nx">changeHandler</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>

<span class="c1">// view.change event --&gt; change view</span>
<span class="nx">pubsub</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="s1">'view.change'</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">propName</span><span class="p">,</span> <span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">elements</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">'[data-bind='</span> <span class="o">+</span> <span class="nx">propName</span> <span class="o">+</span><span class="s1">']'</span><span class="p">),</span>
        <span class="nx">tagName</span><span class="p">;</span>
    <span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="nx">l</span><span class="o">=</span><span class="nx">elements</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">l</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">tagName</span> <span class="o">=</span> <span class="nx">elements</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">();</span>
        <span class="k">if</span><span class="p">(</span><span class="nx">tagName</span><span class="o">===</span><span class="s1">'input'</span> <span class="o">||</span> <span class="nx">tagName</span><span class="o">===</span><span class="s1">'textarea'</span> <span class="o">||</span> <span class="nx">tagName</span><span class="o">===</span><span class="s1">'select'</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">elements</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">newVal</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="nx">elements</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">innerHTML</span> <span class="o">=</span> <span class="nx">newVal</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">});</span>

<span class="kd">var</span> <span class="nx">Model</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="p">{</span>
        <span class="na">props</span><span class="p">:</span> <span class="p">{},</span>
        <span class="na">set</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">propName</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">[</span><span class="nx">propName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="c1">// model change --&gt; publish view.change event</span>
            <span class="nx">pubsub</span><span class="p">.</span><span class="nx">pub</span><span class="p">(</span><span class="s1">'view.change'</span><span class="p">,</span> <span class="nx">propName</span><span class="p">,</span> <span class="nx">value</span><span class="p">);</span>
        <span class="p">},</span>
        <span class="na">get</span><span class="p">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">propName</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="p">.</span><span class="nx">props</span><span class="p">[</span><span class="nx">propName</span><span class="p">];</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="c1">// model.change event --&gt; change model data</span>
    <span class="nx">pubsub</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span><span class="s1">'model.change'</span><span class="p">,</span><span class="kd">function</span><span class="p">(</span><span class="nx">propName</span><span class="p">,</span> <span class="nx">newVal</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">propName</span><span class="p">,</span><span class="nx">newVal</span><span class="p">);</span>
    <span class="p">});</span>
    <span class="k">return</span> <span class="nx">model</span><span class="p">;</span>
<span class="p">}</span>
</code></pre>
</div>

<p>可以看到，我们搞了2个pubsub的”信道”: view.change和model.change
模型的set方法会给view.change信道发消息，改变view
view的监听器会给model.change信道发消息，改变model
这样就完成了双向绑定</p>

        </section>
        
        <footer>
            <div class="row">
            
            
                <article class="6u 12u(small) excerpt">
                    <header>
                        <h2><a href="/javascript/2015/06/09/%E9%9D%9E%E5%B8%B8%E7%AE%80%E5%8D%95%E7%9A%84js%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9A%E6%A1%86%E6%9E%B6-%E4%BA%8C-%E6%8E%A7%E5%88%B6%E5%99%A8%E7%BB%A7%E6%89%BF.html">2015-06-09-非常简单的js双向绑定框架（二）：控制器继承</a></h2>
                    </header>
                    <section>
                        <h1 id="section">初衷</h1>
<p>上一篇已经实现了数据的双向绑定，但model的控制范围是整个文档，在实际工程中必须要有作用范围���以便做ui模块的拆分。
这一篇，我们希望实现像angularjs一样的控制器继承：</p>
<ol>
  <li>父controller的Model可以在子controller里被访问到</li>
  <li>子controller的model不影响父controller</li>
  <li>controller继承关系在html中指定，而不是js中指定</li>
</ol>


                    </section>
                    <footer>
                        <ul class="actions">
                            <li><a href="/javascript/2015/06/09/%E9%9D%9E%E5%B8%B8%E7%AE%80%E5%8D%95%E7%9A%84js%E5%8F%8C%E5%90%91%E7%BB%91%E5%AE%9A%E6%A1%86%E6%9E%B6-%E4%BA%8C-%E6%8E%A7%E5%88%B6%E5%99%A8%E7%BB%A7%E6%89%BF.html" class="button">Read More</a></li>
                        </ul>
                    </footer>
                </article>
            
            
            
            
                <article class="6u$ 12u(small) excerpt f-right">
                    <header>
                        <h2><a href="/javascript/2015/06/11/%E9%9D%9E%E5%B8%B8%E7%AE%80%E5%8D%95%E7%9A%84js%E5%8F%8C%E5%90%91%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A%E6%A1%86%E6%9E%B6-%E4%B8%89-js-model%E9%BB%91%E7%A7%91%E6%8A%80.html">2015-06-11-非常简单的js双向数据绑定框架（三）：js model黑科技</a></h2>
                    </header>
                    <section>
                        <h1 id="section">初衷</h1>
<p>之前我们要在js域更新model，需要这样：</p>


                    </section>
                    <footer>
                        <ul class="actions">
                            <li><a href="/javascript/2015/06/11/%E9%9D%9E%E5%B8%B8%E7%AE%80%E5%8D%95%E7%9A%84js%E5%8F%8C%E5%90%91%E6%95%B0%E6%8D%AE%E7%BB%91%E5%AE%9A%E6%A1%86%E6%9E%B6-%E4%B8%89-js-model%E9%BB%91%E7%A7%91%E6%8A%80.html" class="button">Read More</a></li>
                        </ul>
                    </footer>
                </article>
            
            </div>
        </footer>

    </article>

</div>


        <!-- Footer -->
        <footer id="footer">
            <ul class="icons">

              
              <li>
                <a href="https://github.com/victorisildur" class="icon fa-github">
                  <span class="label">GitHub</span>
                </a>
              </li>
              

              
              <li>
                <a href="https://twitter.com/victorisildur" class="icon fa-twitter">
                  <span class="label">Twitter</span>
                </a>
              </li>
              

              
              <li>
                <a href="https://linkedin.com/in/刘旭" class="icon fa-linkedin">
                  <span class="label">LinkedIn</span>
                </a>
              </li>
              

              

              

              

              
              <li>
                <a href="mailto:isi_liuxu@yeah.net" class="icon fa-envelope-o">
                  <span class="label">Email</span>
                </a>
              </li>
              
            </ul>
            <ul class="copyright">
                <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
                <li>Demo Images: <a href="https://unsplash.com/">Unsplash</a></li>
                <li>Jekyll Template: <a href="http://cloudcannon.com">Cloud Cannon</a></li>
            </ul>
        </footer>

	</body>
</html>
