<!DOCTYPE html>
<html>
  	<head>
  		<title>VictorIsildur's Blog</title>
  		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
  		<meta name="description" content="" />
  		<meta name="keywords" content="" />
  		<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
  		<script src="/js/jquery.min.js"></script>
  		<script src="/js/jquery.poptrox.min.js"></script>
  		<script src="/js/skel.min.js"></script>
  		<script src="/js/init.js"></script>
  		<noscript>
  			<link rel="stylesheet" href="/css/skel.css" />
  			<link rel="stylesheet" href="/css/style.css" />
  			<link rel="stylesheet" href="/css/style-xlarge.css" />
  		</noscript>
  		<!--[if lte IE 8]><link rel="stylesheet" href="/css/ie/v8.css" /><![endif]-->
  	</head>

	<body id="top">

      <header id="header">
          <a href="#" class="image avatar"><img src="/images/aragon.jpg" alt="" /></a>
          <h1><strong>I am <a href="https://github.com/victorisildur">VictorIsildur</a></strong>. First a programmer<br />
          Then a web coder<br />
      </header>


        <div id="main">
    <article>
        <header class="major">
            <h2 class="post-title">2015-05-23-javascript scope chain</h2>
                <p class="post-meta">May 23, 2015</p>
        </header>

        <section>
            <h1 id="scope-chain">scope chain</h1>
<p>一个函数有一个scope chain
函数每调用一次，该函数的scope上创建一个对象，函数的局部变量被当做属性赋值给这个新对象。
所以对嵌套函数</p>
<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">function</span> <span class="nx">A</span><span class="p">()</span> <span class="p">{</span>
	<span class="kd">var</span> <span class="nx">a</span> <span class="o">=</span> <span class="s1">'A'</span><span class="p">;</span>
	<span class="kd">function</span> <span class="nx">B</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">b</span> <span class="o">=</span> <span class="s1">'B'</span>
	<span class="p">}</span>
	<span class="kd">function</span> <span class="nx">C</span><span class="p">()</span> <span class="p">{</span>
		<span class="kd">var</span> <span class="nx">c</span> <span class="o">=</span> <span class="s1">'C'</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<p>scope A   &lt;—  scope B
       ^
       |
       |___ scope C
当A()被调用。 scope A上有新对象，新对象有a属性。
                           scope B上有新对象， 新对象有b属性。
                           scope C上有新对象， 新对象有c属性。
                           B函数内能通过scope chain找到a 属性
                           C函数也能通过scope chain找到a 属性，两者是同一对象。因为都是在A()的这次调用里新建的对象的a属性。</p>

<h1 id="context">context上下文</h1>
<p>阿里前端的一道题：</p>
<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">Obj</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">msg</span> <span class="o">=</span> <span class="s1">'ok'</span><span class="p">;</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">shout</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="nx">alert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">msg</span><span class="p">)</span>
	<span class="p">};</span>
	<span class="k">this</span><span class="p">.</span><span class="nx">waitAndShout</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
		<span class="c1">//填写代码，5s后调用this.shout</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>
<p>错误代码1：</p>
<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">setTimeout</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">shout</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="c1">// illegal invocation</span>
</code></pre>
</div>
<p>错误代码2：</p>
<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">f</span> <span class="o">=</span> <span class="nx">setTimeout</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span>
<span class="nx">f</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">shout</span> <span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="c1">// illegal invocation</span>
</code></pre>
</div>
<p>正确代码：</p>
<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">setTimeout</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">shout</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">)</span> <span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="c1">// this.shout的context由window变为this</span>
</code></pre>
</div>

<h1 id="section">函数调用时，发生了什么</h1>
<p>函数被调用时，将创建一个execution context，创建执行上下文时，发生了三件事：</p>
<ol>
  <li>创建Activation object</li>
  <li>创建arguments 对象</li>
  <li>创建scope</li>
</ol>

<p>这里我们主要关心scope, scope是a list( or a chain ) of objects. 每个函数对象都有一个[[scope]]属性，[[scope]]属性由对象序列or对象链表构成。这个列表/链表被[[scope]]属性引用，Activation object在列表/链表头。
接下来，初始化variables. 也是发生三件事：</p>
<ol>
  <li>函数的参数会变成Activation object的属性。</li>
  <li>内部函数会变成Activation object的属性。</li>
  <li>var 会变成Activation object的属性。</li>
</ol>

<p>这些属性都会赋值为undefined，直到执行函数体里的赋值语句。这就是传说中的Hoisting, 预声明～</p>

<p>scope呢？先看原文：</p>

<blockquote>
  <p>Function objects created with the Function constructor always have a [[scope]] property referring to a scope chain that only contains the global object.
Function objects created with function declarations or function expressions have the scope chain of the execution context in which they are created assigned to their internal [[scope]] property.</p>
</blockquote>

<p>通俗翻译一下：</p>
<ol>
  <li>函数语句声明的函数，[[scope]]指向global object</li>
  <li>函数定义和函数表达式的声明的函数，[[scope]]指向他们执行上下文的[[scope]]</li>
</ol>

<p>Identifier  Resolution:
解析标识符时，沿着[[scope]]指向的scope chain找，第一项显然是Activition Object，里面包含了：参数，内部函数，内部变量。找不到标识付，再去第二项，也就是执行上下文的[[scope]]找。。。依次类推。</p>

<p>所以之前A中含B,C的栗子，B,C的[[scope]]都指向了A的[[scope]]，A的scope chain第一项含有a, 所以B,C都找到a，且是同一个a。</p>

<h1 id="section-1">网易的说法</h1>
<p>网易主要讲了词法环境：
注意词法环境的outer是有静态分析确定的
<img src="http://img.blog.csdn.net/20150607085019998" alt="词法环境" /></p>

<p><a href="http://www.ecma-international.org/publications/standards/Ecma-262.htm">ecma定义</a></p>

<p>函数表达式执行时，函数对象的scope被赋值为当前execution context，和之前的吻合。</p>

        </section>
        
        <footer>
            <div class="row">
            
            
                <article class="6u 12u(small) excerpt">
                    <header>
                        <h2><a href="/2015/05/14/%E5%AE%9E%E4%B9%A0-%E9%A9%AC%E5%85%8B.html">2015-05-14-【实习】马克</a></h2>
                    </header>
                    <section>
                        <h1 id="mysql">mysql</h1>
<ol>
  <li>编码格式
    <ol>
      <li>ALTER TABLE mytable CONVERT TO CHARACTER SET utf8</li>
      <li>DEFAULT CHARACTER SET utf8 COLLATE utf8_general_ci
 4.</li>
    </ol>
  </li>
</ol>


                    </section>
                    <footer>
                        <ul class="actions">
                            <li><a href="/2015/05/14/%E5%AE%9E%E4%B9%A0-%E9%A9%AC%E5%85%8B.html" class="button">Read More</a></li>
                        </ul>
                    </footer>
                </article>
            
            
            
            
                <article class="6u$ 12u(small) excerpt f-right">
                    <header>
                        <h2><a href="/2015/05/29/javascript-%E5%9F%BA%E7%A1%80.html">2015-05-29-javascript 基础</a></h2>
                    </header>
                    <section>
                        <h1 id="section">严格模式</h1>
<h2 id="section-1">好处</h2>
<p>消除语法模糊，避免一些安全问题
提高编译、运行速度</p>
<h2 id="section-2">区别</h2>
<ol>
  <li>不支持全局变量的隐式声明</li>
  <li>不支持对象的重名属性</li>
  <li>不支持argument.callee</li>
</ol>


                    </section>
                    <footer>
                        <ul class="actions">
                            <li><a href="/2015/05/29/javascript-%E5%9F%BA%E7%A1%80.html" class="button">Read More</a></li>
                        </ul>
                    </footer>
                </article>
            
            </div>
        </footer>

    </article>

</div>


        <!-- Footer -->
        <footer id="footer">
            <ul class="icons">

              
              <li>
                <a href="https://github.com/victorisildur" class="icon fa-github">
                  <span class="label">GitHub</span>
                </a>
              </li>
              

              
              <li>
                <a href="https://twitter.com/victorisildur" class="icon fa-twitter">
                  <span class="label">Twitter</span>
                </a>
              </li>
              

              
              <li>
                <a href="https://linkedin.com/in/刘旭" class="icon fa-linkedin">
                  <span class="label">LinkedIn</span>
                </a>
              </li>
              

              

              

              

              
              <li>
                <a href="mailto:isi_liuxu@yeah.net" class="icon fa-envelope-o">
                  <span class="label">Email</span>
                </a>
              </li>
              
            </ul>
            <ul class="copyright">
                <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
                <li>Images: <a href="https://unsplash.com/">Unsplash</a></li>
                <li>Jekyll Template: <a href="http://cloudcannon.com">Cloud Cannon</a></li>
            </ul>
        </footer>

	</body>
</html>
