<!DOCTYPE html>
<html>
  	<head>
  		<title>VictorIsildur's Blog</title>
  		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
  		<meta name="description" content="" />
  		<meta name="keywords" content="" />
  		<!--[if lte IE 8]><script src="css/ie/html5shiv.js"></script><![endif]-->
  		<script src="/js/jquery.min.js"></script>
  		<script src="/js/jquery.poptrox.min.js"></script>
  		<script src="/js/skel.min.js"></script>
  		<script src="/js/init.js"></script>
  		<noscript>
  			<link rel="stylesheet" href="/css/skel.css" />
  			<link rel="stylesheet" href="/css/style.css" />
  			<link rel="stylesheet" href="/css/style-xlarge.css" />
  		</noscript>
        <script>
         (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
             (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
                                  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
         })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

         ga('create', 'UA-82933111-1', 'auto');
         ga('send', 'pageview');
        </script>
  		<!--[if lte IE 8]><link rel="stylesheet" href="/css/ie/v8.css" /><![endif]-->
  	</head>

	<body id="top">

      <header id="header">
          <a href="#" class="image avatar"><img src="/images/aragon.jpg" alt="" /></a>
          <h1><strong>I am <a href="https://github.com/victorisildur">VictorIsildur</a></strong>. First a programmer<br />
          Then a web coder<br />
      </header>


        <div id="main">
    <article>
        <header class="major">
            <h2 class="post-title">用js解析protobuf</h2>
                <p class="post-meta">Jul 1, 2016</p>
        </header>

        <section>
            <h2>varint</h2>

<p>以byte为单位，<code>msb == 1</code>代表数字为完结。
<code>msb == 0</code>代表数字完结。</p>

<p>如果一个数字由多个字节组成，则拼接时使用小端序。
小端序是以byte为单位，而protobuf以7bit为内容单位，所以官网上称之为least significant group first。</p>

<h2>测试</h2>

<p>varint解码过程略简单，测试反而需要点技巧。
npm上有个expect库非常好，要运行es6写的测试用例要用<code>babel-node --presets es2015 test.js</code>来跑，
直接<code>node test.js</code>跑识别不了的。</p>

<h2>repeated</h2>

<p>之前已完成了varint的解码，我们再来看看wire type中其他的类型：</p>

<table><thead>
<tr>
<th>Type</th>
<th>Meaning</th>
<th>Used For</th>
</tr>
</thead><tbody>
<tr>
<td>0</td>
<td>Varint</td>
<td>int32, int64, uint32, uint64, sint32, sint64, bool, enum</td>
</tr>
<tr>
<td>1</td>
<td>64-bit</td>
<td>fixed64, sfixed64, double</td>
</tr>
<tr>
<td>2</td>
<td>lenth-delimited</td>
<td>sting, bytes, embedded msg, packed repeated fields</td>
</tr>
<tr>
<td>3</td>
<td>start group</td>
<td>groups</td>
</tr>
<tr>
<td>4</td>
<td>end group</td>
<td>groups</td>
</tr>
<tr>
<td>5</td>
<td>32-bit</td>
<td>fixed32, sfixed32, float</td>
</tr>
</tbody></table>

<p>我们想要解的message结构如下：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="c1">// 历史记步详情</span>
<span class="nx">message</span> <span class="nx">HistoryDetail</span> <span class="p">{</span>
  <span class="nx">optional</span> <span class="nx">uint32</span> <span class="nx">date</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>                   <span class="c1">//日期，UTC时间</span>
  <span class="nx">optional</span> <span class="nx">uint32</span> <span class="nx">run</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>                    <span class="c1">//跑步步数</span>
  <span class="nx">optional</span> <span class="nx">uint32</span> <span class="nx">walk</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>                   <span class="c1">//走路步数</span>
  <span class="nx">optional</span> <span class="nx">uint32</span> <span class="nx">duration</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>               <span class="c1">//运动时长</span>
<span class="p">}</span>
<span class="c1">//历史记步数据</span>
<span class="nx">message</span> <span class="nx">HistoryData</span> <span class="p">{</span>
  <span class="c1">// 历史运动详情， 数组</span>
  <span class="nx">repeated</span> <span class="nx">HistoryDetail</span> <span class="nx">details</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="c1">//历史数据标记, 手Q回包用</span>
  <span class="nx">optional</span> <span class="nx">uint32</span> <span class="nx">tag</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>
<p>解出来应该是这样：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="p">{</span>
  <span class="nl">details</span><span class="p">:</span>
   <span class="p">[</span> <span class="p">{</span> <span class="na">date</span><span class="p">:</span> <span class="mi">1469599200</span><span class="p">,</span> <span class="na">run</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">walk</span><span class="p">:</span> <span class="mi">5804</span><span class="p">,</span> <span class="na">duration</span><span class="p">:</span> <span class="mi">2447</span> <span class="p">},</span>
     <span class="p">{</span> <span class="na">date</span><span class="p">:</span> <span class="mi">1469685593</span><span class="p">,</span> <span class="na">run</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">walk</span><span class="p">:</span> <span class="mi">38</span><span class="p">,</span> <span class="na">duration</span><span class="p">:</span> <span class="mi">20</span> <span class="p">},</span>
     <span class="p">{</span> <span class="na">date</span><span class="p">:</span> <span class="mi">1469771992</span><span class="p">,</span> <span class="na">run</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">walk</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">duration</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
     <span class="p">{</span> <span class="na">date</span><span class="p">:</span> <span class="mi">1469858392</span><span class="p">,</span> <span class="na">run</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">walk</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">duration</span><span class="p">:</span> <span class="mi">0</span> <span class="p">},</span>
     <span class="p">{</span> <span class="na">date</span><span class="p">:</span> <span class="mi">1469944792</span><span class="p">,</span> <span class="na">run</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">walk</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="na">duration</span><span class="p">:</span> <span class="mi">0</span> <span class="p">}</span> <span class="p">],</span>
  <span class="nx">tag</span><span class="err">:</span> <span class="mi">0</span>
<span class="p">}</span>
</code></pre></div>
<p>对repeat元素，格式是这样的：</p>

<table><thead>
<tr>
<th>byte index</th>
<th>content</th>
</tr>
</thead><tbody>
<tr>
<td>0</td>
<td>tag (field number + wire type)</td>
</tr>
<tr>
<td>1</td>
<td>payload (in bytes)</td>
</tr>
<tr>
<td>...</td>
<td>none embedded elements</td>
</tr>
<tr>
<td>payload + 1</td>
<td>tag</td>
</tr>
<tr>
<td>payload + 2</td>
<td>payload</td>
</tr>
<tr>
<td>...</td>
<td>none embedded elements</td>
</tr>
</tbody></table>

<p>repeated是如何表示的呢？ 那就是有多个tag里的field number是一样的！
解码时应注意把他们Push到一个数组里去。</p>

<h2>message依赖</h2>

<p>对上面的message示例，HistoryData这个message，是依赖HistoryDetail这个message结构的。
所以在解码时，要首先把整个package结构预处理一下，解一下依赖。
然后才能在解HistoryData时正确解HistoryDetail.</p>

<p>具体来说，就是后面的builder依赖于前面构建的builder，代码大致如下：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="kr">const</span> <span class="nx">build</span> <span class="o">=</span> <span class="nx">msgPackage</span> <span class="o">=&gt;</span> <span class="p">{</span>
   <span class="kd">let</span> <span class="nx">builders</span> <span class="o">=</span> <span class="p">{};</span>
   <span class="nx">msgPackage</span><span class="p">.</span><span class="nx">messages</span><span class="p">.</span><span class="nx">forEach</span><span class="p">(</span><span class="nx">message</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="kd">let</span> <span class="nx">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Builder</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">builders</span><span class="p">);</span>
      <span class="nx">builders</span><span class="p">[</span><span class="nx">builder</span><span class="p">.</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">builder</span><span class="p">;</span>
   <span class="p">});</span>
   <span class="k">return</span> <span class="nx">builders</span><span class="p">;</span>
<span class="p">};</span>

</code></pre></div>
<p>注意<code>expect().toEqual()</code>不要做动态object判断，会认为不是一个object.</p>

<h2>字符串格式的bytearray</h2>

<p>处理中发现输入值并不都是形如<code>{0:100, 1:255, 2:13...}</code>这样的bytearr，也有形如<code>CgwI2YWrvQUQABgAIAAQAA==</code>这样的字符串。</p>

<p>咨询小孩后知道，这是base64编码后的ByteArray，解码需用到atob, Uint8Array, ArrayBuffer三个没用过的类，代码如下：</p>
<div class="highlight"><pre><code class="language-javascript" data-lang="javascript"><span class="cm">/* @func: 有概率输入是uint8Array base64后的字符串
 */</span>
<span class="kr">export</span> <span class="kr">const</span> <span class="nx">base64ToByteArr</span>  <span class="o">=</span> <span class="nx">str</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">raw</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">atob</span><span class="p">(</span><span class="nx">str</span><span class="p">),</span>
    <span class="nx">len</span> <span class="o">=</span> <span class="nx">raw</span><span class="p">.</span><span class="nx">length</span><span class="p">,</span>
    <span class="nx">arr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Uint8Array</span><span class="p">(</span><span class="k">new</span> <span class="nx">ArrayBuffer</span><span class="p">(</span><span class="nx">len</span><span class="p">));</span>
    <span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">len</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">arr</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">raw</span><span class="p">.</span><span class="nx">charCodeAt</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="nx">arr</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div>
<p>ArrayBuffer是用户占位的Array，MDN上的描述如下：</p>

<blockquote>
<p>The ArrayBuffer object is used to represent a generic, fixed-length raw binary data buffer. You cannot directly manipulate the contents of an ArrayBuffer; instead, you create one of the typed array objects or a DataView object which represents the buffer in a specific format, and use that to read and write the contents of the buffer.</p>
</blockquote>

        </section>
        
        <footer>
            <div class="row">
            
            
                <article class="6u 12u(small) excerpt">
                    <header>
                        <h2><a href="/programming/2016/05/28/zepto-timepicker.html">zepto timepicker插件</a></h2>
                    </header>
                    <section>
                        自己写的timepicker插件，解决android上time input样式难看、不统一的问题。
                    </section>
                    <footer>
                        <ul class="actions">
                            <li><a href="/programming/2016/05/28/zepto-timepicker.html" class="button">Read More</a></li>
                        </ul>
                    </footer>
                </article>
            
            
            
            
                <article class="6u$ 12u(small) excerpt f-right">
                    <header>
                        <h2><a href="/programming/2016/07/01/es2015.html">全面拥抱es2015: 从页面，后台到测试</a></h2>
                    </header>
                    <section>
                        <p>面向未来编程，从babel es2015开始</p>

                    </section>
                    <footer>
                        <ul class="actions">
                            <li><a href="/programming/2016/07/01/es2015.html" class="button">Read More</a></li>
                        </ul>
                    </footer>
                </article>
            
            </div>
        </footer>

    </article>

</div>


        <!-- Footer -->
        <footer id="footer">
            <ul class="icons">

              
              <li>
                <a href="https://github.com/victorisildur" class="icon fa-github">
                  <span class="label">GitHub</span>
                </a>
              </li>
              

              
              <li>
                <a href="https://twitter.com/isi_liuxu" class="icon fa-twitter">
                  <span class="label">Twitter</span>
                </a>
              </li>
              

              
              <li>
                <a href="https://linkedin.com/in/xu-liu-4a617679" class="icon fa-linkedin">
                  <span class="label">LinkedIn</span>
                </a>
              </li>
              

              

              

              

              
              <li>
                <a href="mailto:isi_liuxu@yeah.net" class="icon fa-envelope-o">
                  <span class="label">Email</span>
                </a>
              </li>
              
            </ul>
            <ul class="copyright">
                <li>Design: <a href="http://html5up.net">HTML5 UP</a></li>
                <li>Images: <a href="https://unsplash.com/">Unsplash</a></li>
                <li>Jekyll Template: <a href="http://cloudcannon.com">Cloud Cannon</a></li>
            </ul>
        </footer>

	</body>
</html>
