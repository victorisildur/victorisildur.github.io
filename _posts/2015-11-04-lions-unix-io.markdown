---
layout: post
title: "莱昂式unix源码阅读3: buffer、磁盘、io"
date: 2015-11-04 13:22:00
categories: os
---

#buffer

buffer是用来降低磁盘操作开销的。

在unix中，磁盘的块大小为512B，为了减少读写磁盘次数。
unix在内核中维护了NBUF个514B的buffer。

为了管理buffer，unix使用两种双向循环链表来管理：

1. av list: available队列。队首是buf bfreelist。
2. b list: device队列。队首是某设备（devtab类型），其他成员都是buf类型。buf是缓存头。

总的原则使，空闲的缓存将挂在av队列中，当需要操作某设备时就从av队列中取下，挂到该设备的b队列中。
设备操作完成后，又重新将其放回到av队列中。

当然，实现上有一些不同，比如：

1. 设备操作完成后，不是直接去把缓存中b队列取下来。而是留待下一次缓存分配的时候。
先从原有b队列取下来，再挂到新的b队列。这样的好处大概是重复配给一个设备时，可以省掉取下挂上的操作。

2. 延迟写。
一旦对缓存的写入结束，该缓存就会释放av队列，但其flag设置了B_DELWRI。
如果该缓存被再次分配，会检查其B_DELWRI标志，如果置位，则首先执行写入，再分配缓存给新设备。

# swap

swap确实涉及到了磁盘！ 就是我们说的内存不够用，换出到磁盘上。

* 高层模型：swapmap（和coremap很像）
    * m_size的单位是"磁盘块"，即512B。
    * m_addr为"磁盘块号"，而不是内存block号。
    * int swplo = 4000;  swap区域从磁盘第4000块开始。
    * in nswap = 872;  swap区域大小为连续872个磁盘块。

# 磁盘

RK磁盘由一个控制器+1~8个device组成。

RK驱动器在核心空间上有6个控制寄存器，起始地址为RKADDR

```c
5363  RKADDR 0177400
```

要启动磁盘驱动，需要首先设置rkda，rkba，rkwc三个寄存器。
然后，设置rkwc，这样就直接启动了磁盘设备。
磁盘操作结束后，会通过矢量地址220产生中断，处理函数是"rkintr"。

